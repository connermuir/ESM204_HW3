---
title: "ESM 204 - Assignment 3"
author: "Conner Smith"
date: "5/2/2022"
output:
  html_document:
   theme:
     bg: "#002B36"
     fg: "#EEE8D5"
     primary: "#2AA198"
   code_folding: hide
   
---

```{r setup, include=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, options(scipen = 999))

library(tidyverse)
library(here)
library(janitor)
library(thematic)
library(scales)
library(equatiomatic)

thematic::thematic_rmd()
thematic::thematic_on()

```


## Overview

```{r}
# Read in the main data set

carbon <- read_csv(here("carbon.csv")) %>% 
  clean_names() %>% 
  select(-x1)

```


The Biden Administration’s “interim” value is $51 per metric ton of CO2. The electricity sector is the second largest source of greenhouse gas emissions in the U.S. (after transportation). In this analysis, we consider the distributional consequences of imposing a household electricity tax based on the SCC to address the climate change problem.


## **Analysis** {.tabset}

The dataset contains the following:

- Consumers can separated into two income groups: “high” and “low.” 
- Price (in $) and quantity (in kWh) estimates of demand per month for the two groups. 

This analysis will start with linear regressions (with an intercept) to estimate the demand curves for “high” and “low” income consumers under the following conditions: 

- Initially, there is no tax on electricity consumption.
- The current electricity price (without any taxes) is $.10 per kWh.
- The marginal cost of producing a kWh of electricity is linear and has a price-intercept of 0.


### **1. MEC**

Assuming that one kWh of electricity emits 0.85 pounds of CO2 and that the interim SCC of $51/ton is accurate, this section calculates the MEC per kWh.

```{r}
# Create a longer dataset where income is a variable, not a column 

carbon_long <- carbon %>% 
  pivot_longer(cols = c(q_low_kwh, q_high_kwh),
               names_to = 'income_level',
               values_to = 'kwh') %>% 
  mutate(income_level = case_when(income_level == 'q_low_kwh' ~ 'low',
                   income_level == 'q_high_kwh' ~ 'high'))

# Run a simple calculation to get the MEC 

interim_price_ton <- 51

#2205 lbs in a metric ton. Divide by 0.85 to get kwh produced per ton

kwh_ton <- 2204.6/0.85

# Multiply by Biden price to get MEC/kWh (Basically, $51 is the price for 2594 kwh)
interim_price_kwh <- 51/kwh_ton

```

Based on this, the marginal externality cost per kWh of electricity is $`r round(interim_price_kwh, 4)`.

### **2. Aggregations**

**Low income demand curve:**
```{r}
# Calculate aggregate demand curve for electricity

# First get lm estimates from data for both low and high
demand_low <- lm(price_cents ~ kwh, income_level=='low', 
                 data = carbon_long) 
extract_eq(model = demand_low, use_coefs = TRUE, coef_digits = 5)

```

**High income demand curve:**
```{r}
demand_high <- lm(price_cents ~ kwh, income_level=='high',
                  data = carbon_long) 
extract_eq(model = demand_high, use_coefs = TRUE, coef_digits = 5)

# Generalized demand model from sample code 
demand <- function(p, model){
  q <- (p - model$coefficients[[1]])/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)
  return(q)
}

# Generalized aggregate demand from code sample (gives sluightly different value than manual attempt)
demand_agg <- function(p){
  q <- demand(p, demand_low) + demand(p, demand_high)
  return(q)
}

#demand_agg(10)
#536,719.5 kWh consumed @ $0.10
```

Given these income-based demand curves, we can sum horizontally to get the **aggregate demand curve:**

```{r}
# Make a vector and extract the lm 
price = seq(0, 30, length.out = 100)

Qagg <- map(price, demand_agg) %>% 
  unlist()

agg_df<- tibble(Qagg = Qagg, price = price)

demand_agg_eq <- lm(price ~ Qagg, data = agg_df) 
extract_eq(model = demand_agg_eq, use_coefs = TRUE, coef_digits = 5)
```

*Note: this gives price in cents, not dollars*

```{r}
# Switch the equations above so Q is on one side and then add 

agg_slope <- demand_agg_eq$coefficients[2]
agg_int <- demand_agg_eq$coefficients[1]

# Aggregate demand function is P = 29.78135 - 0.00004(Qagg)

```

Now we need to calculate the supply curve for electricity. We already know that the current price is $0.10/kWh. We also know the MC for electricity is linear with a 0 intercept. 

```{r}

kwh_agg <- demand_agg(10)
#536,719.5 kWh consumed @ $0.10

supply_slope <- 10/kwh_agg
```

Since we know the supply curve will pass through the aggregate demand curve at the level of demand for a price of $0.10/kwh, we can infer that the supply curve (or marginal cost per kWh of electricity) function is: 

*P = 0.0000186Q*

*Note: this gives a price in cents, not dollars*

From this, we can calculate consumer and producer surplus as well as environmental cost. 

```{r}
# CS needs Y intercept --> at 0 kWh, price would be $0.305

# Note the conversion back to dollars 
cs_baseline <- 0.5*kwh_agg*(0.305 - 0.10)
# $55,013.74

# PS easy, just go up to 10 and out to the kwh 
ps_baseline <- 0.5*kwh_agg*0.10
# $26,835.97

# cost is rectangle 
env_cost_baseline <- interim_price_kwh*kwh_agg
# $10,553.75
```

- Consumer Benefit = $`r round(cs_baseline, 0)`
- Producer Benefit = $`r round(ps_baseline, 0)`
- Environmental Cost = $`r round(env_cost_baseline, 0)`

*Note these benefits and costs are in dollars, not cents*

### **3. Consumer Benefit**
 
From above, we have a total consumer surplus of $53,518.
This comes from an aggregate demand curve that indicates 522,128 kWh will be consumed at  price of $0.10/kWh. 

To get the surplus differential between income groups, we use the current price and calculate the amount each group will consume at this level. 

```{r}
# low income demand
# demand(10, demand_low)
# Low income gets 121,344 
#demand_low$coefficients[1] --- intercept is 23.37

cs_low <- 0.5*(.2337 - .10)*demand(10, demand_low)
# $8,112 CS for low income (note dollars/cents conversion)

#demand(10, demand_low)
#High gets 415,376
#demand_high$coefficients[1] --- intercept is 31.61
cs_high <- 0.5*(.3161-.10)*demand(10, demand_high)
# $44,881.3 CS for high income 
```

This indicates clear disparity where consumer surplus for high income consumers is much higher than that for low income consumers. The difference is as follows: 

- Low-income CS: $`r round(cs_low, 0)`
- High-income CS: $`r round(cs_high, 0)`

### **4. Optimal Tax**

In earlier sections, we determined that the marginal environmental cost of carbon is $0.0197 per kWh of electricity consumed. This is also the optimal tax level. Since we are assuming this is entirely borne by low-income consumers, we will apply this tax to the low-income demand. Supply will stay the same. This will shift low-income demand down and we will recalculate the aggregate demand to get the new demand and price values (**I Don't Really Follow the wording of this at all, this interpretation could be off**)

```{r}
# Add tax to the demand for the low-income demand (this will now be lower)

# Low income demand is 23.37097 - 0.00011kwh initially

tax_cents <- 1.97
# Note this is in cents

low_int_tax <- demand_low$coefficients[1] - tax
#low_int_tax
#Tax basically lowers intercept for low income 

demand_low_tax <- function(p){
  q <- (p - low_int_tax)/
  demand_low$coefficients[[2]]
  return(q)}

# Now we get the new AD curve, note that the high income stays the same here.

demand_agg_tax <- function(p){
  q <- demand_low_tax(p) + demand(p, demand_high)
  return(q)
}

demand_agg_tax <- demand_agg_tax(10)
#518,841

demand_change <- kwh_agg-demand_agg_tax
# A. Reduction in kwh consumed of 17,878

# B. I don't think we are assuming anything happens to the price of electricity, only the quantity should change with the shift in demand 

# C. High income surplus shouldn't change 

# D. Low income surplus 
cs_low_tax <- 0.5*(.214 - .10)*demand_low_tax(10)
# CS for low income now $5898

cs_low_change <- cs_low - cs_low_tax
#Dropped by $2214

#E. PS decreases 
ps_tax <- 0.5*demand_agg_tax*0.10
ps_change <- ps_baseline - ps_tax
#$894 decrease 

#F. ENV damage decreases 
damage_tax <- interim_price_kwh*demand_agg_tax
damage_baseline <- interim_price_kwh*kwh_agg
damage_change <- damage_baseline - damage_tax
#Damage goes down by $352 

#G. Tax revenue 

tax_revenue <- interim_price_kwh*demand_low_tax(10)
# $2,034 tax revenue 

```

**A:** The amount of electricity produced/consumed *decreases* by `r round(demand_change, 0)`kWh. The new total consumption is $`r round(demand_agg_tax, 0)`

**B:** The price of electricity is assumed to stay the same if all costs are borne by low income consumers. 

**C:** The welfare of high-income consumers remains unchanged ($`r round(cs_high, 0)`).

**D:** The welfare of low-income consumers *decreases* by $`r round(cs_low_change, 0)`. 
The new total is $`r round(cs_low_tax, 0)`.

**E:** The producer surplus *decreases* by $ `r round(ps_change, 0)`.

**F:** The environmental damage *decreases* by $`r round(damage_change, 0)`.

**G:** The tax revenue generated is $`r round(tax_revenue, 0)`.

### **5. Redistribution**

### **6. Solar PV**